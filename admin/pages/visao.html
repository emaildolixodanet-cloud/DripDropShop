<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, maximum-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="theme-color" content="#0A0A0F">
  <title>Vis√£o ¬∑ DripDrop Admin</title>
  
  <link rel="manifest" href="../manifest.json">
  <link rel="apple-touch-icon" sizes="180x180" href="../assets/logo-180.png">
  
  <script src="../scripts/auth-check.js"></script>
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;700&family=Inter:wght@400;500;600;700&family=Space+Grotesk:wght@700&display=swap" rel="stylesheet">
  
  <link rel="stylesheet" href="../styles/design-system.css">

  <style>
    .sub-tabs {
      display: flex; gap: 4px;
      background: var(--bg-elevated); border: 1px solid var(--border-subtle);
      border-radius: var(--radius-lg); padding: 4px; margin-bottom: var(--space-lg);
    }
    .sub-tab {
      flex: 1; padding: 10px 16px; border: none; border-radius: var(--radius-md);
      background: transparent; color: var(--text-tertiary);
      font-family: var(--font-accent); font-size: 13px; font-weight: 700;
      text-transform: uppercase; letter-spacing: 0.5px; cursor: pointer;
      transition: none; text-align: center;
    }
    .sub-tab.active { background: var(--primary); color: #fff; box-shadow: 0 2px 8px var(--primary-glow); }
    .tab-panel { display: none; }
    .tab-panel.active { display: block; }

    /* Operation item */
    .op-item {
      background: var(--bg-elevated); border: 1px solid var(--border-subtle);
      border-radius: var(--radius-lg); padding: var(--space-md);
      margin-bottom: var(--space-sm); display: flex;
      justify-content: space-between; align-items: center;
    }
    .op-item__info { flex: 1; min-width: 0; }
    .op-item__title { font-family: var(--font-display); font-size: 14px; font-weight: 700; }
    .op-item__meta { font-size: 12px; color: var(--text-secondary); margin-top: 2px; }
    .op-item__stock {
      font-family: var(--font-display); font-size: 20px; font-weight: 700;
      min-width: 40px; text-align: center;
    }
    .sell-btn {
      padding: 8px 14px; border: none; border-radius: var(--radius-md);
      background: rgba(0, 230, 118, 0.15); border: 1px solid rgba(0, 230, 118, 0.3);
      color: var(--success); font-family: var(--font-accent); font-size: 12px;
      font-weight: 700; cursor: pointer; text-transform: uppercase; letter-spacing: 0.5px;
      transition: none; white-space: nowrap;
    }

    /* Analytics cards */
    .stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-md); margin-bottom: var(--space-lg); }
    .stat-card {
      background: var(--bg-elevated); border: 1px solid var(--border-subtle);
      border-radius: var(--radius-lg); padding: var(--space-lg); text-align: center;
    }
    .stat-card__label { font-family: var(--font-accent); font-size: 11px; font-weight: 700;
      text-transform: uppercase; letter-spacing: 0.5px; color: var(--text-tertiary); margin-bottom: 8px; }
    .stat-card__value { font-family: var(--font-display); font-size: 24px; font-weight: 700; }
    .stat-card__value.positive { color: var(--success); }
    .stat-card__value.negative { color: var(--critical); }
    .stat-card__value.neutral { color: var(--primary-light); }

    /* Sales history */
    .sale-row {
      display: flex; justify-content: space-between; align-items: center;
      padding: 12px 0; border-bottom: 1px solid var(--border-subtle);
      font-size: 14px;
    }
    .sale-row:last-child { border-bottom: none; }
    .sale-date { font-size: 12px; color: var(--text-tertiary); }
    .sale-amount { font-family: var(--font-display); font-weight: 700; color: var(--success); }
    .sale-product { font-weight: 600; }
    .sale-profit { font-size: 12px; }
    .sale-profit.positive { color: var(--success); }
    .sale-profit.negative { color: var(--critical); }

    .section-label {
      font-family: var(--font-accent); font-size: 12px; font-weight: 700;
      text-transform: uppercase; letter-spacing: 1px; color: var(--text-tertiary);
      margin-bottom: var(--space-md); margin-top: var(--space-lg);
    }
  </style>
</head>
<body>

  <header class="app-header">
    <button class="app-header__back" onclick="window.history.back()">‚Üê Voltar</button>
    <h1 class="app-header__title">VIS√ÉO</h1>
    <div class="app-header__actions"></div>
  </header>

  <main class="container section">

    <div class="sub-tabs">
      <button class="sub-tab active" data-tab="operacoes">Opera√ß√µes</button>
      <button class="sub-tab" data-tab="analytics">Analytics</button>
    </div>

    <!-- ====== OPERA√á√ïES ====== -->
    <div class="tab-panel active" id="panel-operacoes">

      <div class="card card--glass mb-lg">
        <div class="flex justify-between items-center">
          <div>
            <div class="text-tertiary text-sm text-accent">EM ARMAZ√âM</div>
            <div class="text-display" style="font-size:28px" id="opUnits">0</div>
          </div>
          <div class="text-right">
            <div class="text-tertiary text-sm text-accent">VENDAS HOJE</div>
            <div class="text-display" style="font-size:28px;color:var(--success)" id="opSalesToday">0</div>
          </div>
        </div>
      </div>

      <div id="opList"></div>

      <div class="empty-state" id="opEmpty" style="display:none">
        <div class="empty-state__icon">üìä</div>
        <h3 class="empty-state__title">Sem stock</h3>
        <p class="empty-state__description">Adiciona produtos no Stock primeiro.</p>
      </div>

    </div>

    <!-- ====== ANALYTICS ====== -->
    <div class="tab-panel" id="panel-analytics">

      <div class="stat-grid">
        <div class="stat-card">
          <div class="stat-card__label">Investimento</div>
          <div class="stat-card__value neutral" id="anInvestment">0‚Ç¨</div>
        </div>
        <div class="stat-card">
          <div class="stat-card__label">Receita</div>
          <div class="stat-card__value positive" id="anRevenue">0‚Ç¨</div>
        </div>
        <div class="stat-card">
          <div class="stat-card__label">Lucro</div>
          <div class="stat-card__value" id="anProfit">0‚Ç¨</div>
        </div>
        <div class="stat-card">
          <div class="stat-card__label">Margem</div>
          <div class="stat-card__value" id="anMargin">0%</div>
        </div>
      </div>

      <div class="stat-grid" style="grid-template-columns:1fr">
        <div class="stat-card">
          <div class="stat-card__label">Total vendas</div>
          <div class="text-display" style="font-size:32px" id="anSalesCount">0</div>
        </div>
      </div>

      <div class="section-label">Hist√≥rico de Vendas</div>

      <div class="card" id="salesHistory">
        <div class="empty-state" id="salesEmpty">
          <div class="empty-state__icon" style="font-size:32px">üìã</div>
          <p class="empty-state__description" style="margin:0">Nenhuma venda registada.</p>
        </div>
      </div>

    </div>

  </main>

  <!-- SELL MODAL -->
  <div class="modal-backdrop" id="sellModal">
    <div class="modal">
      <div class="modal__handle"></div>
      <div class="modal__header">
        <h2 class="modal__title">Registar Venda</h2>
      </div>
      <div id="sellInfo" style="margin-bottom:var(--space-md)"></div>
      <div class="input-group">
        <label class="input-label" for="sm_qty">Quantidade</label>
        <input class="input" type="number" id="sm_qty" value="1" min="1"/>
      </div>
      <div class="input-group">
        <label class="input-label" for="sm_price">Valor de venda (‚Ç¨)</label>
        <input class="input" type="number" id="sm_price" placeholder="0.00" step="0.01" min="0"/>
      </div>
      <div class="modal__actions">
        <button class="btn btn--secondary" id="sellCancel">Cancelar</button>
        <button class="btn btn--primary" id="sellConfirm">Confirmar Venda</button>
      </div>
    </div>
  </div>

  <!-- TAB BAR -->
  <nav class="tab-bar">
    <a href="./stock.html" class="tab-bar__item">
      <span class="tab-bar__icon">üì¶</span>
      <span>Stock</span>
    </a>
    <a href="./site.html" class="tab-bar__item">
      <span class="tab-bar__icon">üåê</span>
      <span>Site</span>
    </a>
    <a href="./visao.html" class="tab-bar__item active">
      <span class="tab-bar__icon">üìä</span>
      <span>Vis√£o</span>
    </a>
    <a href="./extra.html" class="tab-bar__item">
      <span class="tab-bar__icon">üîÆ</span>
      <span>Extra</span>
    </a>
    <a href="./settings.html" class="tab-bar__item">
      <span class="tab-bar__icon">‚öôÔ∏è</span>
      <span>Config</span>
    </a>
  </nav>

  <script>
    // ==========================================
    // VIS√ÉO - OPERA√á√ïES + ANALYTICS
    // ==========================================

    // Shared data with Stock page (mock - same structure)
    // In production this reads from Sheets
    let stockItems = [
      { id: "RL-HOODIE", color: "Azul", size: "M", stock: 5 },
      { id: "RL-HOODIE", color: "Azul", size: "L", stock: 2 },
      { id: "RL-HOODIE", color: "Verde", size: "M", stock: 1 },
      { id: "CARH-JACKET", color: "Preto", size: "L", stock: 3 }
    ];

    let costPrices = { "RL-HOODIE": 18, "CARH-JACKET": 25 };

    let sales = JSON.parse(localStorage.getItem('dd-sales') || '[]');

    function saveSales() { localStorage.setItem('dd-sales', JSON.stringify(sales)); }

    // --- SUB-TABS ---
    document.querySelectorAll('.sub-tab').forEach(tab => {
      tab.addEventListener('click', () => {
        document.querySelectorAll('.sub-tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
        tab.classList.add('active');
        document.getElementById('panel-' + tab.dataset.tab).classList.add('active');
        if (tab.dataset.tab === 'analytics') renderAnalytics();
      });
    });

    // --- OPERA√á√ïES ---

    function renderOperations() {
      const list = document.getElementById('opList');
      list.innerHTML = '';

      const totalUnits = stockItems.reduce((s, i) => s + i.stock, 0);
      document.getElementById('opUnits').textContent = totalUnits;

      const today = new Date().toISOString().split('T')[0];
      const salesToday = sales.filter(s => s.date === today).length;
      document.getElementById('opSalesToday').textContent = salesToday;

      if (stockItems.length === 0) {
        document.getElementById('opEmpty').style.display = 'block';
        return;
      }
      document.getElementById('opEmpty').style.display = 'none';

      stockItems.forEach((item, idx) => {
        const div = document.createElement('div');
        div.className = 'op-item';

        let stockColor = 'var(--text-primary)';
        if (item.stock === 0) stockColor = 'var(--critical)';
        else if (item.stock <= 3) stockColor = 'var(--warning)';

        div.innerHTML = `
          <div class="op-item__info">
            <div class="op-item__title">${item.id}</div>
            <div class="op-item__meta">${item.color} ¬∑ ${item.size} ¬∑ Custo: ${(costPrices[item.id] || 0).toFixed(2)}‚Ç¨</div>
          </div>
          <div class="op-item__stock" style="color:${stockColor}">${item.stock}</div>
          <button class="sell-btn" data-sell-index="${idx}" ${item.stock === 0 ? 'disabled style="opacity:0.3"' : ''}>
            üí∞ Vender
          </button>
        `;
        list.appendChild(div);
      });
    }

    // --- SELL MODAL ---

    let sellingIndex = null;
    const sellModal = document.getElementById('sellModal');

    document.getElementById('opList').addEventListener('click', (e) => {
      const btn = e.target.closest('[data-sell-index]');
      if (!btn || btn.disabled) return;

      sellingIndex = Number(btn.dataset.sellIndex);
      const item = stockItems[sellingIndex];

      document.getElementById('sellInfo').innerHTML = `
        <div class="card card--glass" style="padding:var(--space-md)">
          <div class="text-base font-semibold">${item.id}</div>
          <div class="text-sm text-secondary">${item.color} ¬∑ ${item.size} ¬∑ Stock: ${item.stock}</div>
        </div>
      `;
      document.getElementById('sm_qty').value = 1;
      document.getElementById('sm_qty').max = item.stock;
      document.getElementById('sm_price').value = '';

      sellModal.classList.add('active');
      document.body.style.overflow = 'hidden';
    });

    document.getElementById('sellCancel').onclick = () => {
      sellModal.classList.remove('active');
      document.body.style.overflow = '';
    };

    sellModal.addEventListener('click', (e) => {
      if (e.target === sellModal) {
        sellModal.classList.remove('active');
        document.body.style.overflow = '';
      }
    });

    document.getElementById('sellConfirm').onclick = () => {
      const item = stockItems[sellingIndex];
      const qty = Number(document.getElementById('sm_qty').value) || 1;
      const sellValue = Number(document.getElementById('sm_price').value);

      if (!sellValue || sellValue <= 0) { alert('Introduz o valor da venda.'); return; }
      if (qty > item.stock) { alert('Quantidade superior ao stock.'); return; }

      // Register sale
      const cost = costPrices[item.id] || 0;
      sales.push({
        date: new Date().toISOString().split('T')[0],
        timestamp: Date.now(),
        productId: item.id,
        color: item.color,
        size: item.size,
        qty: qty,
        sellValue: sellValue,
        costValue: cost * qty,
        profit: sellValue - (cost * qty)
      });

      // Deduct stock
      item.stock -= qty;

      saveSales();
      sellModal.classList.remove('active');
      document.body.style.overflow = '';
      renderOperations();
      showToast(`Venda registada: ${sellValue.toFixed(2)}‚Ç¨`, 'success');
    };

    // --- ANALYTICS ---

    function renderAnalytics() {
      const totalInvestment = stockItems.reduce((s, i) => s + (i.stock * (costPrices[i.id] || 0)), 0);
      const totalRevenue = sales.reduce((s, sale) => s + sale.sellValue, 0);
      const totalCostSold = sales.reduce((s, sale) => s + sale.costValue, 0);
      const totalProfit = totalRevenue - totalCostSold;
      const margin = totalRevenue > 0 ? (totalProfit / totalRevenue * 100) : 0;

      document.getElementById('anInvestment').textContent = totalInvestment.toFixed(2) + '‚Ç¨';
      document.getElementById('anRevenue').textContent = totalRevenue.toFixed(2) + '‚Ç¨';

      const profitEl = document.getElementById('anProfit');
      profitEl.textContent = totalProfit.toFixed(2) + '‚Ç¨';
      profitEl.className = `stat-card__value ${totalProfit >= 0 ? 'positive' : 'negative'}`;

      const marginEl = document.getElementById('anMargin');
      marginEl.textContent = margin.toFixed(1) + '%';
      marginEl.className = `stat-card__value ${margin >= 0 ? 'positive' : 'negative'}`;

      document.getElementById('anSalesCount').textContent = sales.length;

      // Sales history
      const historyContainer = document.getElementById('salesHistory');
      historyContainer.innerHTML = '';

      if (sales.length === 0) {
        historyContainer.innerHTML = `
          <div class="empty-state" style="padding:var(--space-lg)">
            <div style="font-size:32px;opacity:0.5;margin-bottom:8px">üìã</div>
            <p class="text-sm text-secondary">Nenhuma venda registada.</p>
          </div>
        `;
        return;
      }

      // Show most recent first
      [...sales].reverse().forEach(sale => {
        const row = document.createElement('div');
        row.className = 'sale-row';
        const profitClass = sale.profit >= 0 ? 'positive' : 'negative';
        const profitSign = sale.profit >= 0 ? '+' : '';
        row.innerHTML = `
          <div>
            <div class="sale-product">${sale.productId}</div>
            <div class="sale-date">${sale.date} ¬∑ ${sale.color} ¬∑ ${sale.size} ¬∑ x${sale.qty}</div>
          </div>
          <div style="text-align:right">
            <div class="sale-amount">${sale.sellValue.toFixed(2)}‚Ç¨</div>
            <div class="sale-profit ${profitClass}">${profitSign}${sale.profit.toFixed(2)}‚Ç¨</div>
          </div>
        `;
        historyContainer.appendChild(row);
      });
    }

    // --- TOAST ---

    function showToast(message, type = "success") {
      const existing = document.querySelector('.toast-notification');
      if (existing) existing.remove();
      const toast = document.createElement("div");
      toast.className = `toast-notification badge badge--${type}`;
      toast.textContent = message;
      Object.assign(toast.style, {
        position: "fixed", top: "calc(70px + env(safe-area-inset-top, 0px))",
        left: "50%", transform: "translateX(-50%)", zIndex: "1000",
        padding: "12px 24px", fontSize: "14px", boxShadow: "var(--shadow-lg)",
        animation: "slideDown 0.3s ease-out"
      });
      document.body.appendChild(toast);
      setTimeout(() => {
        toast.style.opacity = "0"; toast.style.transition = "opacity 0.3s";
        setTimeout(() => toast.remove(), 300);
      }, 2000);
    }

    // --- INIT ---
    renderOperations();
  </script>

  <script>
    const savedTheme = localStorage.getItem('dripdrop-theme') || 'dark';
    document.documentElement.setAttribute('data-theme', savedTheme);
  </script>
</body>
</html>
